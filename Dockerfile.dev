FROM bitnami/magento:2.2.6-debian-9-r8

ADD . /opt/flowcommerce/flowconnector

WORKDIR /opt/bitnami/magento/htdocs

ARG MAGENTO2_REPO_PRIVATE_KEY

RUN return $(echo -n "$MAGENTO2_REPO_PRIVATE_KEY" | wc -c)

RUN find . -type d -print0 | xargs -0 chmod 775 && \
    find . -type f -print0 | xargs -0 chmod 664 && \
    chown -R bitnami:daemon /opt/bitnami/magento/htdocs && \
    echo 'memory_limit = 2048M' >> /opt/bitnami/php/lib/php.ini

RUN composer config repositories.flowconnector path /opt/flowcommerce/flowconnector && \
    composer config repo.0 false && \
    composer config repositories.magento '{ "type": "composer", "url": "https://repo.magento.com" }' && \
    composer config http-basic.repo.magento.com e09972697200676346ab7a6981ac63fa $MAGENTO2_REPO_PRIVATE_KEY

RUN composer require --no-interaction flowcommerce/flowconnector @dev && \
    composer require --no-interaction magento/module-bundle-sample-data:100.2.* && \
    composer require --no-interaction magento/module-sales-sample-data:100.2.* && \
    composer require --no-interaction magento/module-customer-sample-data:100.2.* && \
    composer require --no-interaction magento/module-catalog-sample-data:100.2.* && \
    composer require --no-interaction magento/module-theme-sample-data:100.2.* && \
    composer require --no-interaction magento/module-cms-sample-data:100.2.* && \
    composer require --no-interaction magento/module-widget-sample-data:100.2.* && \
    composer require --no-interaction magento/module-catalog-rule-sample-data:100.2.* && \
    composer require --no-interaction magento/module-sales-rule-sample-data:100.2.* && \
    composer require --no-interaction magento/module-review-sample-data:100.2.* && \
    composer require --no-interaction magento/module-tax-sample-data:100.2.* && \
    composer require --no-interaction magento/module-downloadable-sample-data:100.2.* && \
    composer require --no-interaction magento/module-msrp-sample-data:100.2.* && \
    composer require --no-interaction magento/module-wishlist-sample-data:100.2.* && \
    composer require --no-interaction magento/module-configurable-sample-data:100.2.* && \
    composer require --no-interaction magento/module-product-links-sample-data:100.2.* && \
    composer require --no-interaction magento/module-grouped-product-sample-data:100.2.* && \
    composer require --no-interaction magento/module-offline-shipping-sample-data:100.2.* && \
    composer require --no-interaction magento/module-swatches-sample-data:100.2.* && \
    composer require --no-interaction magento/sample-data-media:100.2.*

RUN php bin/magento module:enable --all
RUN php bin/magento setup:di:compile
RUN php bin/magento sampledata:deploy

EXPOSE 80 443

ENTRYPOINT ["/opt/flowcommerce/flowconnector/entrypoint.sh"]
CMD [ "httpd", "-f", "/bitnami/apache/conf/httpd.conf", "-DFOREGROUND" ]

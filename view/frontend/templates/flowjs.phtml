<?php
/**
 * FlowCommerce
 *
 * FlowCommerce_FlowConnector
 * @category    FlowCommerce
 * @package     FlowCommerce_FlowConnector
 * @author      FlowCommerce
 * @copyright   Copyright (c) 2019 FlowCommerce
 */

/** @var $block \FlowCommerce\FlowConnector\Block\FlowJS */
?>
<?php if ($block->isFlowEnabled()) : ?>
    <?php
    $maxCatalogHideMs = (int)$block->getFlowMaxCatalogHideMs();
    $maxCartHideMs = (int)$block->getFlowMaxCartHideMs();
    ?>
    <script type="text/x-magento-init">
    {
        "*": {
            "FlowCommerce_FlowConnector/js/flow-init": {
                "organization_id": <?= /* @escapeNotVerified */ (string)$block->getFlowOrganizationId() ?>,
                "enabled": true,
                "production": <?= /* @escapeNotVerified */ (int)$block->isFlowProduction() ?>,
                "support_discounts": <?= /* @escapeNotVerified */ (int)$block->isFlowSupportMagentoDiscounts() ?>,
                "cart_localize": <?= /* @escapeNotVerified */ (int)$block->isFlowCartLocalize() ?>,
                "catalog_localize": <?= /* @escapeNotVerified */ (int)$block->isFlowCatalogLocalize() ?>,
                "pricing_timeout": <?= /* @escapeNotVerified */ $maxCatalogHideMs ?>,
                "cart_timeout": <?= /* @escapeNotVerified */ $maxCartHideMs ?>
            }
        }
    }
    </script>

    <script type="text/javascript">
    setTimeout(function(){
        document.head.append(`
            body [data-role="priceBox"] span.price {
                opacity: 1;
            } 
        `);
    }, <?= $maxCatalogHideMs ?>);

    setTimeout(function(){
        document.head.append(`
            body.checkout-cart-index .form-cart span.price,
            body.checkout-cart-index .cart-summary span.price,
            body #minicart-content-wrapper span.price {
                opacity: 1;
            }
        `);
    }, <?= $maxCartHideMs ?>);
    </script>
    <?php if ($maxCatalogHideMs > 0) : ?>
        <style>
        [data-role="priceBox"] span.price {
            opacity: 0;
        } 
        body.flow-catalog-localized [data-role="priceBox"] span.price {
            opacity: 1;
        }
        </style>
    <?php endif; ?>
    <?php if ($maxCartHideMs > 0) : ?>
        <style>
        .checkout-cart-index .form-cart span.price,
        .checkout-cart-index .cart-summary span.price,
        #minicart-content-wrapper span.price {
            opacity: 0;
        } 
        .flow-cart-localized.checkout-cart-index .form-cart span.price,
        .flow-cart-totals-localized.checkout-cart-index .cart-summary span.price,
        .flow-cart-localized #minicart-content-wrapper span.price {
            opacity: 1;
        }
        </style>
    <?php endif; ?>
<?php endif; ?>
